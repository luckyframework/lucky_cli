#!/bin/sh

# Exit if any subcommand fails
set -e

if ! command -v yarn > /dev/null; then
  printf 'Yarn is not installed.\n'
  printf 'See https://yarnpkg.com/lang/en/docs/install/ for install instructions.\n'
  exit 1
fi

if ! command -v heroku > /dev/null; then
  printf 'Heroku CLI is not installed.\n'
  printf 'See https://devcenter.heroku.com/articles/heroku-cli for install instructions.\n'
  exit 1
fi

echo "\n▸ Installing node dependencies"
yarn install 2>&1 | sed 's/^/  /'

echo "\n▸ Compiling assets"
bin/compile_assets build 2>&1 | sed 's/^/  /'

echo "\n▸ Installing shards"
crystal deps 2>&1 | sed 's/^/  /'

echo "\n▸ Setting up the database"
lucky db.create 2>&1 | sed 's/^/  /'

echo "\n▸ Migrating the database"
lucky db.migrate 2>&1 | sed 's/^/  /'

echo "\n▸ All done. Run 'lucky dev' to start the app"
